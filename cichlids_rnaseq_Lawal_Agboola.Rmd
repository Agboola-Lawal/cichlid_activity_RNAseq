---
title: "Differential Gene Expression Analysis in Cichlid Brain Samples"
author: "Lawal Agboola"
date: "2024-12-29"
output: html_document
---

## Introduction

This R Markdown performs differential gene expression (DGE) analysis on RNA-seq data from four *cichlid* fish species with distinct activity patterns:

| Species | Abbreviation | Activity Pattern |
|----------|---------------|------------------|
| *Tropheops kumwera* | Tk | Diurnal |
| *Astatotilapia calliptera* | Ac | Diurnal |
| *Astatotilapia labrosus* | Al | Nocturnal |
| *Aulonocara stuartgranti* | As | Nocturnal |

RNA-seq reads were aligned to the *Maylandia zebra* reference genome (Ensembl) using **STAR**, and quality was checked with **FastQC**.  
Gene-level count data (from `featureCounts`) were imported here for statistical analysis with **DESeq2**.  
Enrichment analyses were conducted with **clusterProfiler** to identify biological processes and pathways distinguishing diurnal vs. nocturnal species.

---

## Load Required Libraries
```{r message=FALSE, warning=FALSE}
library(DESeq2)
library(tidyverse)
library(dplyr)
library(pheatmap)
library(ggplot2)
library(readxl)
library(ggtext)
library(ggrepel)
library(RColorBrewer)
library(tibble)
library(dendextend)
library(biomaRt)
library(AnnotationHub)
library(GenomicFeatures)
library(AnnotationForge)
library(dplyr)
library(txdbmaker)
library(rtracklayer)
library(AnnotationDbi)
library(clusterProfiler)
library(DBI)
library(BiocManager)
library(org.Dr.eg.db)   # Zebrafish orthologs used as reference (closest available annotation)

```

```{r}
setwd("C:/Users/agboo/Desktop/Keen's Lab/Cichlids project/cichlid_rna_seq")
```

```{r}
# Read precomputed count matrix (rows = genes, columns = samples)

raw_counts <- read.csv("cichlids_counts_data.csv", row.names = 1)

# Read annotation file (gene IDs and names from M. zebra Ensembl release)

gene_info <- read.csv("M_zebra_gene_info.csv")
```

# Define biological groups for each sample
```{r}
clade <- factor(c(
rep("Ac", 6), # Astatotilapia calliptera (diurnal)
rep("Tk", 6), # Tropheops kumwera (diurnal)
rep("Al", 4), # Astatotilapia labrosus (nocturnal)
rep("As", 6) # Aulonocara stuartgranti (nocturnal)
))

activity_pattern <- factor(c(
rep("diurnal", 12),
rep("nocturnal", 10)
))

# Combine into DESeq2 sample metadata

coldata <- data.frame(
row.names = colnames(raw_counts),
clade,
activity_pattern
)

```

# Differential Expression Analysis
```{r}
# Create DESeq2 dataset and specify design

dds <- DESeqDataSetFromMatrix(
countData = raw_counts,
colData = coldata,
design = ~ activity_pattern
)

# Run DESeq2 normalization and model fitting

dds <- DESeq(dds)

# Extract results for diurnal vs nocturnal comparison

res <- results(dds, contrast = c("activity_pattern", "diurnal", "nocturnal"))

#Convert to data frame and add gene IDs

res_df <- as.data.frame(res)
res_df$GeneID <- rownames(res_df)
```

# Filter and Save Differentially Expressed Genes (DEGs)
```{r}
# Filter for significant genes (FDR ≤ 0.05)

sig_genes <- subset(res_df, padj <= 0.05 & !is.na(padj))

# Separate up- and downregulated genes

up_genes <- subset(sig_genes, log2FoldChange > 1)
down_genes <- subset(sig_genes, log2FoldChange < -1)

# Merge with annotation

up_genes <- merge(up_genes, gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)
down_genes <- merge(down_genes, gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)

# Save results

write.csv(up_genes, "results/up_diurnal.csv", row.names = FALSE)
write.csv(down_genes, "results/down_diurnal.csv", row.names = FALSE)

```

# Visualization of Differential Expression
```{r}
# MA Plot (global expression changes)

plotMA(res, ylim = c(-5, 5), main = "MA Plot: Diurnal vs Nocturnal")

# Volcano plot

res_df %>%
mutate(Significance = case_when(
padj < 0.05 & log2FoldChange > 1 ~ "Upregulated",
padj < 0.05 & log2FoldChange < -1 ~ "Downregulated",
TRUE ~ "Not significant"
)) %>%
ggplot(aes(x = log2FoldChange, y = -log10(padj), color = Significance)) +
geom_point(alpha = 0.6) +
scale_color_manual(values = c("Upregulated" = "red", "Downregulated" = "blue", "Not significant" = "grey")) +
theme_minimal() +
labs(title = "Volcano Plot: Diurnal vs Nocturnal", x = "Log2 Fold Change", y = "-Log10 Adjusted p-value")

```


```{r}
# Filter for significant genes with padj ≤ 0.05
sig_genes <- results_diurnal_vs_nocturnal[which(results_diurnal_vs_nocturnal$padj <= 0.05 & !is.na(results_diurnal_vs_nocturnal$padj)), ]

# upregulated genes
# Positively regulated genes (log2FoldChange > 0)
upregulated_genes <- sig_genes[sig_genes$log2FoldChange > 1, ]
upregulated_genes <- data.frame(upregulated_genes)

# insert genename
# Convert row names to first column
upregulated_genes <- 
  data.frame(GeneID = rownames(upregulated_genes), upregulated_genes, row.names = NULL)

# Perform the merge on the "Gene stable ID" column
upregulated_genes <- merge(upregulated_genes, 
                           gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)

upregulated_genes <- upregulated_genes[!is.na(upregulated_genes$GeneName), ]

write.csv(upregulated_genes, "up_diurnal0.csv")

# Negatively regulated genes (log2FoldChange < 0)
downregulated_genes <- sig_genes[sig_genes$log2FoldChange < 0, ]
downregulated_genes <- data.frame(downregulated_genes)

# insert genename
# Convert row names to first column
downregulated_genes <- data.frame(GeneID = rownames(downregulated_genes), downregulated_genes, row.names = NULL)

# Perform the merge on the "Gene stable ID" column
downregulated_genes <- merge(downregulated_genes, 
                           gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)

downregulated_genes <- downregulated_genes[!is.na(downregulated_genes$GeneName), ]

write.csv(downregulated_genes, "down_diurnal0.csv")
```

## GO and KEGG Pathway Enrichment Analysis
# Go analysis up
```{r}
upregulated_genes <- read.csv("up_diurnal0.csv")

gene_list <- upregulated_genes$GeneName

# Perform GO Enrichment Analysis

go_enrich <- enrichGO(
    gene          = gene_list,       # List of genes
    OrgDb         = org.Dr.eg.db,    # Zebrafish annotation database
    keyType       = "SYMBOL",        # Adjust if using Ensembl ("ENSEMBL") or Entrez ("ENTREZID")
    ont           = "BP",            # Ontology: "BP" (Biological Process), "MF", or "CC"
    pAdjustMethod = "BH",            # Adjusted p-value method (Benjamini-Hochberg)
    pvalueCutoff  = 0.5,             # p-value cutoff for significance
    qvalueCutoff  = 0.5              # q-value cutoff
)

# # View results
# head(go_enrich)
# 
# # Plot top 20 enriched GO terms
#barplot(go_enrich, showCategory=20, title="GO Enrichment (Biological Process)")
# dotplot(go_enrich, showCategory=20, title="GO Enrichment (Biological Process)")


#  Perform KEGG Pathway Enrichment Analysis

gene_entrez <- bitr(gene_list, fromType="SYMBOL", toType="ENTREZID", OrgDb=org.Dr.eg.db)
entrez_ids <- gene_entrez$ENTREZID  # Extract Entrez IDs

kegg_enrich <- enrichKEGG(
    gene          = entrez_ids,
    organism      = "dre",           # "dre" for Zebrafish, check KEGG for supported organisms
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.5,
    qvalueCutoff  = 0.5
)

write.csv(go_enrich@result, "GO_Enrichment_Results_up_diurnal.csv")
write.csv(kegg_enrich@result, "KEGG_Enrichment_Results_up_diurnal.csv")

# Generate a dotplot with better aesthetics for GO
dotplot(go_enrich, showCategory = 20) +
    theme_minimal(base_size = 16) +  # Use a clean minimal theme
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),  # Rotate x-axis labels
        axis.text.y = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Center plot title
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14, face = "bold"),  # Adjust legend title
        plot.margin = margin(10, 10, 10, 10),  # Add some margin around the plot
        panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add a black border
    ) +
    scale_color_viridis_c(option = "plasma") +  # Use Viridis color palette for better visibility
    labs(
        title = "GO Enrichment (Biological Process)",
        x = "Gene Ratio",
        #y = "GO Terms",
        color = "Adjusted p-value"
    )
  
ggsave("GO_Enrichment_diurnal_up.png", width = 10, height = 10, dpi = 300)  

# __________________
# KEGG Pathway Enrichment

# Generate a dotplot with better aesthetics for KEGG
dotplot(kegg_enrich, showCategory = 20) +
    theme_minimal(base_size = 16) +  # Use a clean minimal theme
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),  # Rotate x-axis labels
        axis.text.y = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Center plot title
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14, face = "bold"),  # Adjust legend title
        plot.margin = margin(10, 10, 10, 10),  # Add some margin around the plot
        panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add a black border
    ) +
    scale_color_viridis_c(option = "plasma") +  # Use Viridis color palette for better visibility
    labs(
        title = "KEGG Pathway Enrichment",
        x = "Gene Ratio",
        #y = "GO Terms",
        color = "Adjusted p-value"
    )

# Save as png
ggsave("KEGG_pathway_enrichment_diurnal_up.png", width = 9, height = 10, dpi = 300)  # Adjust height as needed

```

# Go analysis down
```{r}
downregulated_genes <- read.csv("down_diurnal0.csv")

gene_list <- downregulated_genes$GeneName

# Perform GO Enrichment Analysis

go_enrich <- enrichGO(
    gene          = gene_list,       # List of genes
    OrgDb         = org.Dr.eg.db,    # Zebrafish annotation database
    keyType       = "SYMBOL",        # Adjust if using Ensembl ("ENSEMBL") or Entrez ("ENTREZID")
    ont           = "BP",            # Ontology: "BP" (Biological Process), "MF", or "CC"
    pAdjustMethod = "BH",            # Adjusted p-value method (Benjamini-Hochberg)
    pvalueCutoff  = 0.5,            # p-value cutoff for significance
    qvalueCutoff  = 0.5             # q-value cutoff
)

# # View results
# head(go_enrich)
# 
# # Plot top 20 enriched GO terms
#barplot(go_enrich, showCategory=20, title="GO Enrichment (Biological Process)")
# dotplot(go_enrich, showCategory=20, title="GO Enrichment (Biological Process)")


#  Perform KEGG Pathway Enrichment Analysis

gene_entrez <- bitr(gene_list, fromType="SYMBOL", toType="ENTREZID", OrgDb=org.Dr.eg.db)
entrez_ids <- gene_entrez$ENTREZID  # Extract Entrez IDs

kegg_enrich <- enrichKEGG(
    gene          = entrez_ids,
    organism      = "dre",# "dre" for Zebrafish, check KEGG for supported organisms
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.1,
    qvalueCutoff  = 0.1
)

# write.csv(go_enrich@result, "GO_Enrichment_Results.csv")
# write.csv(kegg_enrich@result, "KEGG_Enrichment_Results.csv")

# ________________

# Generate a dotplot with better aesthetics for GO
dotplot(go_enrich, showCategory = 20) +
    theme_minimal(base_size = 16) +  # Use a clean minimal theme
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),  # Rotate x-axis labels
        axis.text.y = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Center plot title
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14, face = "bold"),  # Adjust legend title
        plot.margin = margin(10, 10, 10, 10),  # Add some margin around the plot
        panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add a black border
    ) +
    scale_color_viridis_c(option = "plasma") +  # Use Viridis color palette for better visibility
    labs(
        title = "GO Enrichment (Biological Process)",
        x = "Gene Ratio",
        #y = "GO Terms",
        color = "Adjusted p-value"
    )
  
ggsave("GO Enrichment_diurnal_down.png", width = 10, height = 10, dpi = 300)  

# __________________
# KEGG Pathway Enrichment

# Generate a dotplot with better aesthetics for KEGG
dotplot(kegg_enrich, showCategory = 20) +
    theme_minimal(base_size = 16) +  # Use a clean minimal theme
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),  # Rotate x-axis labels
        axis.text.y = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Center plot title
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14, face = "bold"),  # Adjust legend title
        plot.margin = margin(10, 10, 10, 10),  # Add some margin around the plot
        panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add a black border
    ) +
    scale_color_viridis_c(option = "plasma") +  # Use Viridis color palette for better visibility
    labs(
        title = "KEGG Pathway Enrichment",
        x = "Gene Ratio",
        #y = "GO Terms",
        color = "Adjusted p-value"
    )

# Save as png
ggsave("KEGG_pathway_enrichment_diurnal_down.png", width = 9, height = 10, dpi = 300)  # Adjust height as needed

```



```{r}
#btbd9/mtnr1aa/nfil3-5/nampt1/ezh2/bmal1a/prkaa2/ncoa2/timeless

# Extract results
res <- results(dds)

#########################################
## btbd9
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005006488", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "btbd9",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## mtnr1aa
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005007308", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "mtnr1aa",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 


#########################################
## nfil3-5
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005010014", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "nfil3-5",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## nampt1
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005010766", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "nampt1",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## ezh2
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005013319", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "ezh2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## ezh2
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005013706", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "ezh2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## bmal1a
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005014899", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "bmal1a",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## prkaa2
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005019786", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "prkaa2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## ncoa2
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005021584", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "ncoa2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 


## timeless
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005022364", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "timeless",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 



```


# Positively regulated genes (log2FoldChange >= 1)
```{r}
upregulated_genes1 <- sig_genes[sig_genes$log2FoldChange >= 1, ]
upregulated_genes1 <- data.frame(upregulated_genes1)

# insert genename
# Convert row names to first column
upregulated_genes1 <- 
  data.frame(GeneID = rownames(upregulated_genes1), upregulated_genes1, row.names = NULL)

# Perform the merge on the "Gene stable ID" column
upregulated_genes1 <- merge(upregulated_genes1, 
                        gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)

upregulated_genes1 <- upregulated_genes1[!is.na(upregulated_genes1$GeneName), ]

write.csv(upregulated_genes1, "up_diurnalFoldchange1.csv")

# Negatively regulated genes (log2FoldChange <= -1)
downregulated_genes1 <- sig_genes[sig_genes$log2FoldChange <= -1, ]
downregulated_genes1 <- data.frame(downregulated_genes1)

# insert genename
# Convert row names to first column
downregulated_genes1 <- 
  data.frame(GeneID = rownames(downregulated_genes1), downregulated_genes1, row.names = NULL)

# Perform the merge on the "Gene stable ID" column
downregulated_genes1 <- merge(downregulated_genes1, 
                           gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)

downregulated_genes1 <- downregulated_genes1[!is.na(downregulated_genes1$GeneName), ]

write.csv(downregulated_genes1, "down_diurnalFoldchange1.csv")

```


# Go analysis up
```{r}
upregulated_genes1 <- read.csv("up_diurnalFoldchange1.csv")

gene_list <- upregulated_genes1$GeneName

# Perform GO Enrichment Analysis

go_enrich <- enrichGO(
    gene          = gene_list,       # List of genes
    OrgDb         = org.Dr.eg.db,    # Zebrafish annotation database
    keyType       = "SYMBOL",        # Adjust if using Ensembl ("ENSEMBL") or Entrez ("ENTREZID")
    ont           = "BP",            # Ontology: "BP" (Biological Process), "MF", or "CC"
    pAdjustMethod = "BH",            # Adjusted p-value method (Benjamini-Hochberg)
    pvalueCutoff  = 0.5,            # p-value cutoff for significance
    qvalueCutoff  = 0.5             # q-value cutoff
)

# # View results
# head(go_enrich)
# 
# # Plot top 20 enriched GO terms
#barplot(go_enrich, showCategory=20, title="GO Enrichment (Biological Process)")
# dotplot(go_enrich, showCategory=20, title="GO Enrichment (Biological Process)")


#  Perform KEGG Pathway Enrichment Analysis

gene_entrez <- bitr(gene_list, fromType="SYMBOL", toType="ENTREZID", OrgDb=org.Dr.eg.db)
entrez_ids <- gene_entrez$ENTREZID  # Extract Entrez IDs

kegg_enrich <- enrichKEGG(
    gene          = entrez_ids,
    organism      = "dre",           # "dre" for Zebrafish, check KEGG for supported organisms
    pAdjustMethod = "BH",
    pvalueCutoff  = 0.5,
    qvalueCutoff  = 0.5
)

# write.csv(go_enrich@result, "GO_Enrichment_Results_up_diurnal.csv")
# write.csv(kegg_enrich@result, "KEGG_Enrichment_Results_up_diurnal.csv")

# Generate a dotplot with better aesthetics for GO
dotplot(go_enrich, showCategory = 20) +
    theme_minimal(base_size = 16) +  # Use a clean minimal theme
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),  # Rotate x-axis labels
        axis.text.y = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Center plot title
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14, face = "bold"),  # Adjust legend title
        plot.margin = margin(10, 10, 10, 10),  # Add some margin around the plot
        panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add a black border
    ) +
    scale_color_viridis_c(option = "plasma") +  # Use Viridis color palette for better visibility
    labs(
        title = "GO Enrichment (Biological Process)",
        x = "Gene Ratio",
        #y = "GO Terms",
        color = "Adjusted p-value"
    )
  
ggsave("GO_Enrichment_diurnal_up1.png", width = 10, height = 10, dpi = 300)  

# __________________
# KEGG Pathway Enrichment

# Generate a dotplot with better aesthetics for KEGG
dotplot(kegg_enrich, showCategory = 20) +
    theme_minimal(base_size = 16) +  # Use a clean minimal theme
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),  # Rotate x-axis labels
        axis.text.y = element_text(size = 14, face = "bold"),
        axis.title = element_text(size = 16, face = "bold"),
        plot.title = element_text(size = 18, face = "bold", hjust = 0.5),  # Center plot title
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14, face = "bold"),  # Adjust legend title
        plot.margin = margin(10, 10, 10, 10),  # Add some margin around the plot
        panel.border = element_rect(color = "black", fill = NA, size = 1)  # Add a black border
    ) +
    scale_color_viridis_c(option = "plasma") +  # Use Viridis color palette for better visibility
    labs(
        title = "KEGG Pathway Enrichment",
        x = "Gene Ratio",
        #y = "GO Terms",
        color = "Adjusted p-value"
    )

# Save as png
ggsave("KEGG_pathway_enrichment_diurnal_up1.png", width = 9, height = 10, dpi = 300)  # Adjust height as needed

```


# Ensure your coldata is already defined as mentioned
```{r}
clade <- factor(c("A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera",
                  "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera",
                  "A_labrosus", "A_labrosus", "A_labrosus", "A_labrosus",
                  "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti"))

sex <- factor(c("male", "male", "male", "male", "male", "female",
                "male", "female", "male", "female", "female", "female",
               "female", "male", "female", "male",
               "female", "female", "male", "male", "male", "female"))

coldata <- data.frame(row.names = colnames(raw_counts), clade, sex)

```

# filter zero out of the data
```{r}
#Counts <- raw_counts[which(rowSums(raw_counts) > 50),]
```

# Run DESeq
```{r}
dds <- DESeqDataSetFromMatrix(countData = Counts, 
                              colData = coldata, 
                              design = ~clade + sex + clade:sex)

dds <- DESeq(dds)
```

# PCA plot
```{r}
vsd <- vst(dds, blind = TRUE)  # Variance stabilizing transformation

# Perform PCA analysis
pcaData <- plotPCA(vsd, intgroup = "clade", returnData = TRUE)

# Calculate percentage of variance
percentVar <- round(100 * attr(pcaData, "percentVar"))

# Create the PCA plot with ggplot2
ggplot(pcaData, aes(x = PC1, y = PC2, color = clade, label = rownames(pcaData))) +
  geom_point(size = 3) +                    # Plot points
  geom_text(vjust = -1, size = 3) +         # Add sample names as labels
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +  # X-axis label
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +  # Y-axis label
  theme_minimal() +                         # Use a clean theme
  theme(legend.position = "right",          # Place legend on the right
        plot.title = element_text(hjust = 0.5)) + # Center plot title
  ggtitle("PCA Plot of RNA-seq Data by Clade")    # Add plot title

```

#  Investigate Count Data Quality
```{r}
boxplot(log10(counts(dds, normalized=TRUE) + 1), main="Normalized Counts Per Sample")

```

#  Evaluate Sample Outliers
```{r}
sampleDists <- dist(t(assay(vsd)))
heatmap(as.matrix(sampleDists), symm=TRUE, main="Sample Distance Matrix")
```
#

```{r}
dds <- dds[rowSums(counts(dds) >= 10) >= 2, ]

vsd <- vst(dds, blind = TRUE)  # Variance stabilizing transformation

plotPCA(vsd, intgroup = c("clade"))
```


```{r}
# Extract results
res <- results(dds)

#########################################
## mtnr1aa
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005007308", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "mtnr1aa",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## mtnr1al
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005004554", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "mtnr1al",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## mtnr1c
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005010186", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "mtnr1c",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## mtnr1bb
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005019438", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "mtnr1bb",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## aanat1
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005001038", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "aanat1",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

#########################################
## asmt
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005010427", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "asmt",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

```
## Opsin genes

```{r}
## opn1sw1
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005015119", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn1sw1",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 


## opn1sw2B
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005010258", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn1sw2B",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 


## opn4
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005004638", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn4",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## opn3
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005011964", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn3",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

## opn6a
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005000389", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn6a",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## opn8c
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005001026", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn8c",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange


## opn6a
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005015347", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn6a",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## opn7b
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005026553", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn7b",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## opn7d
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005026384", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn7d",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## opn4b
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005003144", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "opn4b",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

## rho
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005023772", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "rho",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

## cry-dash
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005019606", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cry-dash",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange
```


## Clock gene

```{r}

## clocka
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005020202", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "clocka",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## clockb
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005023826", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "clockb",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## cipca
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005020659", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cipca",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## cipcb
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005011159", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cipcb",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## per1b
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005021382", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "per1b",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## per2
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005025436", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti")) 

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "per2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## per3
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005021666", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "per3",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## timeless
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005022364", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "timeless",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## cry1a
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005001451", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cry1a",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################

## cry1b
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005017214", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cry1b",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

###################
## cry2
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005022850", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cry2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## cry3b
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005026798", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cry3b",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## cry5
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005008861", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "cry5",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange


###################
## nr1d1
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005004281", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "nr1d1",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## nr1d2a
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005016315", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "nr1d2a",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## nr1d2b
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005017041", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "nr1d2b",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## rorb
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005010610", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "rorb",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## rorcb
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005025643", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "rorcb",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## rorca
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005005882", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "rorca",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## roraa
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005022429", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "roraa",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## bmal2
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005018896", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "bmal2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## bmal1a
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005014899", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "bmal1a",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

###################
## BMAL2
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005014994", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "BMAL2",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange

```
## Sleep and Wakefulness Genes
```{r}
## hcrt
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005022730", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "hcrt",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 



## adora2aa
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005002189", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "adora2aa",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 


## gabra1
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005008540", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "gabra1",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## drd2l
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005007578", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "drd2l",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 

## drd2a
# Plot normalized counts for a gene of interest
gene_counts <- plotCounts(dds, gene = "ENSMZEG00005015835", intgroup = "clade", returnData = TRUE)

# Set the order of clades as a factor
gene_counts$clade <- factor(gene_counts$clade, levels = c("T_kumwera", "A_calliptera", "A_labrosus", "A_stuartgranti"))

# Create the bar chart
ggplot(gene_counts, aes(x = clade, y = count, fill = clade)) +
  stat_summary(fun = mean, geom = "bar", width = 0.6) +  # Bar for mean expression
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2) +  # Error bars
  labs(title = "drd2a",
       x = "Clade", 
       y = "Normalized Counts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("A_calliptera" = "#f46d43",  # Navy Blue
                               "T_kumwera" = "#f46d43",  # Navy Blue
                               "A_labrosus" = "#2166ac",  # Orange
                               "A_stuartgranti" = "#2166ac" ))  # Orange 
```


```{r}
# genes_of_interest  <- read.csv("gene_of_interest.csv")
goi_final  <- read.csv("goi_final.csv")

genes_of_interest <- c("ENSMZEG00005007308", "ENSMZEG00005004554", "ENSMZEG00005010186", "ENSMZEG00005019438", "ENSMZEG00005001038", "ENSMZEG00005010427", "ENSMZEG00005022730", "ENSMZEG00005002189", "ENSMZEG00005008540", "ENSMZEG00005007578", "ENSMZEG00005015835",  "ENSMZEG00005015119", "ENSMZEG00005010258", "ENSMZEG00005004638", "ENSMZEG00005011964", "ENSMZEG00005000389", "ENSMZEG00005001026", "ENSMZEG00005015347", "ENSMZEG00005026553", "ENSMZEG00005026384", "ENSMZEG00005003144", "ENSMZEG00005023772", "ENSMZEG00005019606", "ENSMZEG00005026798", "ENSMZEG00005008861", "ENSMZEG00005004281",   "ENSMZEG00005016315", "ENSMZEG00005017041", "ENSMZEG00005010610", "ENSMZEG00005025643", "ENSMZEG00005005882", "ENSMZEG00005022429", "ENSMZEG00005018896", "ENSMZEG00005014899", "ENSMZEG00005014994")

goi_final <- c("ENSMZEG00005007308", "ENSMZEG00005010186", "ENSMZEG00005019438", "ENSMZEG00005002189", "ENSMZEG00005008540", "ENSMZEG00005015835",  "ENSMZEG00005011964", "ENSMZEG00005015347", "ENSMZEG00005026553", "ENSMZEG00005003144", "ENSMZEG00005019606", "ENSMZEG00005004281", "ENSMZEG00005016315", "ENSMZEG00005010610", "ENSMZEG00005022429", "ENSMZEG00005018896", "ENSMZEG00005014899", "ENSMZEG00005014994")

# Extract normalized counts for these genes (using variance-stabilized data)
vsd <- vst(dds, blind = FALSE)  # Use rlog(dds) if preferred
selected_counts <- assay(vsd)[genes_of_interest, ]

# Scale the data for clustering
scaled_counts <- t(scale(t(selected_counts)))

# Add clade information
avg_counts <- as.data.frame(t(selected_counts)) %>%
  mutate(clade = colData(dds)$clade) %>%
  group_by(clade) %>%
  summarise(across(everything(), mean))

# Transpose back for clustering
avg_counts_matrix <- as.matrix(t(avg_counts[,-1]))
colnames(avg_counts_matrix) <- avg_counts$clade

write.csv(avg_counts_matrix, file = "GOI_avg.csv")
```



```{r}
# read table gene of interest
GOI_avg <- read.csv(file = "GOI_avg.csv")

# change colname X to gene_id
colnames(GOI_avg)[1] <- "gene_id"

# Transform from wide to long
GOI_avg_long <- GOI_avg %>% pivot_longer(-gene_id) %>%
  set_names(c("Gene_ID", "Species", "Gene_expression"))

GOI_avg_long %>% 
  ggplot(aes(x = Species, y = Gene_ID,
             fill = Gene_expression))+
  geom_tile() + 
  scale_fill_continuous(low = "#FFFFFF",
                        high = "#f46d43",
                        name = "Scale")+
  theme_classic()+
  theme(axis.title.x = element_markdown(),
        axis.title.y = element_markdown()) 
  
```


## Gene of interest
```{r}
# Generate the dendrogram
pheatmap(scaled_counts,
         clustering_distance_rows = "euclidean",  # Distance metric for genes
         clustering_distance_cols = "euclidean",  # Distance metric for samples
         clustering_method = "complete",          # Hierarchical clustering method
         color = colorRampPalette(rev(brewer.pal(n = 9, name = "RdBu")))(100),
         main = "Dendrogram of Selected Genes",
         fontsize_row = 10,
         fontsize_col = 10,
         treeheight_row = 30,
         treeheight_col = 30,
         show_rownames = TRUE,
         show_colnames = TRUE)
```


```{r}
goi_final <- c("ENSMZEG00005007308", "ENSMZEG00005010186", "ENSMZEG00005019438", "ENSMZEG00005002189", "ENSMZEG00005008540", "ENSMZEG00005015835",  "ENSMZEG00005011964", "ENSMZEG00005015347", "ENSMZEG00005026553", "ENSMZEG00005003144", "ENSMZEG00005019606", "ENSMZEG00005004281", "ENSMZEG00005016315", "ENSMZEG00005010610", "ENSMZEG00005022429", "ENSMZEG00005018896", "ENSMZEG00005014899", "ENSMZEG00005014994")

# Extract normalized counts for these genes (using variance-stabilized data)
vsd <- vst(dds, blind = FALSE)  # Use rlog(dds) if preferred
selected_counts_final <- assay(vsd)[goi_final, ]

# Scale the data for clustering
scaled_counts_final <- t(scale(t(selected_counts_final)))

# Add clade information
avg_counts_final <- as.data.frame(t(scaled_counts_final)) %>%
mutate(clade = colData(dds)$clade) %>%
group_by(clade) %>%
summarise(across(everything(), mean))

# Transpose back for clustering
avg_counts_matrixf_final <- as.matrix(t(avg_counts_final[,-1]))
colnames(avg_counts_matrixf_final) <- avg_counts_final$clade
# 
# write.csv(avg_counts_matrixf_final, file = "GOIfinal_avg.csv")
#  
# read table gene of interest
GOIfinal_avg <- read.csv(file = "GOIfinal_avg.csv")
 
# dendogram
# change colname X to gene_id
colnames(GOIfinal_avg)[1] <- "gene_id"
 
# Transform from wide to long
GOIfinal_avg_long <- GOIfinal_avg %>% pivot_longer(-gene_id) %>%
set_names(c("Gene_ID", "Species", "Gene_expression"))
 
GOIfinal_avg_long %>% 
   ggplot(aes(x = Species, y = Gene_ID,
              fill = Gene_expression))+
   geom_tile() + 
   scale_fill_continuous(low = "#FFFFFF",
                         high = "#f46d43",
                         name = "Scale")+
   theme_classic()+
   theme(axis.title.x = element_markdown(),
         axis.title.y = element_markdown()) 

# using gene name
genes_of_interest_final <- read.csv(file = "goi_final.csv")
geneGOIfinal_avg <- GOIfinal_avg
geneGOIfinal_avg$gene_name <- genes_of_interest_final$gene_name
geneGOIfinal_avg <- geneGOIfinal_avg[,-1]
geneGOIfinal_avg_long <- geneGOIfinal_avg %>% pivot_longer(-gene_name) %>%
set_names(c("Gene_name","Species", "Gene_expression"))

# ggplot
geneGOIfinal_avg_long %>% 
   ggplot(aes(x = Species, y = Gene_name,
              fill = Gene_expression))+
   geom_tile() + 
   scale_fill_continuous(low = "#FFFFFF",
                         high = "#f46d43",
                         name = "Scale",
                         expand = c(0,0))+
   theme_classic()+
   theme(axis.title.x = element_markdown(),
         axis.title.y = element_markdown(),
         axis.line = element_blank(),
         axis.ticks = element_blank())+
  coord_fixed(ratio = 0.2)
```


```{r}
# Calculate average gene expression for each clade
avg_clade_counts <- as.data.frame(t(scaled_counts_final)) %>%
  mutate(clade = colData(dds)$clade) %>%
  group_by(clade) %>%
  summarise(across(everything(), mean))

# Convert to matrix
avg_clade_matrix <- as.matrix(avg_clade_counts[,-1])
rownames(avg_clade_matrix) <- avg_clade_counts$clade

# --- Different Clustering Methods ---

# 1. Correlation-based distance with Ward's method
cor_dist <- as.dist(1 - cor(t(avg_clade_matrix), method = "pearson"))
hclust_ward <- hclust(cor_dist, method = "ward.D2")

# Ward's Method
plot(hclust_ward,
     #main = "Ward's Method (Correlation Distance)",
     #xlab = "Clade",
     #ylab = "Height",
     #col.main = "darkblue",
     hang = -1,
     cex = 1.2,
     las = 2,  # Make the dendrogram vertical
     lwd = 1)      # Increase line thickness

# method 2
library(dendextend)

# Convert hclust to dendrogram
dend <- as.dendrogram(hclust_ward)

# Adjust line thickness and orientation
dend <- dend %>%
  set("branches_lwd", 1) %>%  # Increase line thickness
  set("hang_leaves", -1) %>%  # Align leaves
  set("labels_cex", 0.8)      # Reduce label size to fit

# Align leaves
# Adjust margins
par(mar = c(5, 5, 5, 10))
# Plot vertical dendrogram
plot(dend, 
     #main = "Ward's Method (Correlation Distance)",
     horiz = TRUE,  # Make it vertical
     axes = FALSE)

```


```{r}
# Load required libraries
library(pheatmap)

# Prepare the data by converting to matrix
heatmap_matrix <- geneGOIfinal_avg_long %>%
  pivot_wider(names_from = Species, values_from = Gene_expression) %>%
  column_to_rownames("Gene_name") %>%
  as.matrix()

# Define color gradient similar to ggplot
heatmap_colors <- colorRampPalette(c("#FFFFFF", "#f46d43"))(100)

# Adjust cell size and ensure no cutting by increasing figure size
pheatmap(heatmap_matrix,
         color = heatmap_colors,            # Color scale
         cluster_rows = TRUE,                # Cluster rows to show dendrogram
         cluster_cols = TRUE,                 # Cluster columns to show dendrogram
         show_rownames = TRUE,                # Show gene names
         show_colnames = TRUE,                # Show species names
         border_color = NA,                   # Remove grid lines
         #main = "Gene Expression Heatmap",    # Title
         fontsize_row = 10,                    # Adjust row font size
         fontsize_col = 10,                    # Adjust column font size
         cellwidth = 60,                        # Increase cell width
         cellheight = 20,                       # Increase cell height
         treeheight_row = 50,                   # Height of row dendrogram
         treeheight_col = 50,                   # Height of column dendrogram
         filename = "heatmap_output.png",       # Save to a file to avoid truncation
         width = 12,                            # Adjust width to fit
         height = 10                            # Adjust height to fit
)
```

## Selecting gene_expression among clades
```{r}

# Read raw counts data
#raw_counts <- read.csv("cichlids_counts_data.csv", row.names = 1)

# Ensure your coldata is already defined as mentioned
clade <- factor(c("A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "A_labrosus", "A_labrosus", "A_labrosus", "A_labrosus", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti"))

sex <- factor(c("male", "male", "male", "male", "male", "female",
                "male", "female", "male", "female", "female", "female",
               "female", "male", "female", "male",
               "female", "female", "male", "male", "male", "female"))

coldata <- data.frame(row.names = colnames(raw_counts), clade, sex)


# Run DESeq

dds <- DESeqDataSetFromMatrix(countData = Counts, 
                              colData = coldata, 
                              design = ~clade + sex + clade:sex)

dds <- DESeq(dds)

```

## More expressed genes in Nocturnal
```{r}
# Extract results for T_kumwera vs A_stuartgranti
res_Tk.vs.As <- results(dds, contrast = c("clade", "T_kumwera", "A_stuartgranti"))

# View the results
head(res_Tk.vs.As)

# Extract results for T_kumwera vs A_labrosus
res_Tk.vs.Al <- results(dds, contrast = c("clade", "T_kumwera", "A_labrosus"))

# View the results
head(res_Tk.vs.Al)

# Extract results for A_calliptera vs A_stuartgranti
res_Ac.vs.As <- results(dds, contrast = c("clade", "A_calliptera", "A_stuartgranti"))

# View the results
head(res_Ac.vs.As)

# Extract results for A_calliptera vs A_labrosus
res_Ac.vs.Al <- results(dds, contrast = c("clade", "A_calliptera", "A_labrosus"))

# View the results
head(res_Ac.vs.Al)

# Filter genes with padj < 0.05 (statistically significant)
sig_res_Tk.vs.As <- subset(res_Tk.vs.As, padj < 0.05)
sig_res_Tk.vs.Al <- subset(res_Tk.vs.Al, padj < 0.05)
sig_res_Ac.vs.As <- subset(res_Ac.vs.As, padj < 0.05)
sig_res_Ac.vs.Al <- subset(res_Ac.vs.Al, padj < 0.05)
```

## High genes in Diurnal
```{r}
higher_in_Tk1 <- subset(sig_res_Tk.vs.As, log2FoldChange > 0)
higher_in_Tk2 <- subset(sig_res_Tk.vs.Al, log2FoldChange > 0)
higher_in_Ac1 <- subset(sig_res_Ac.vs.As, log2FoldChange > 0)
higher_in_Ac2 <- subset(sig_res_Ac.vs.Al, log2FoldChange > 0)

# Extract gene names from each list
genes_Tk1 <- rownames(higher_in_Tk1)
genes_Tk2 <- rownames(higher_in_Tk2)
genes_Ac1 <- rownames(higher_in_Ac1)
genes_Ac2 <- rownames(higher_in_Ac2)

# Combine all gene names into one vector
Diu_all_genes <- c(genes_Tk1, genes_Tk2, genes_Ac1, genes_Ac2)

# Remove duplicate gene names
Diu_unique_genes <- unique(Diu_all_genes)

# Convert to a data frame for saving
Diu_unique_genes_df <- data.frame(GeneName = Diu_unique_genes)

# Save as a CSV file
write.csv(Diu_unique_genes_df, "unique_genes_combined.csv", row.names = FALSE)

# View the final unique gene names
head(Diu_unique_genes_df)

```


## High genes in Nocturnal
```{r}
higher_in_As1 <- subset(sig_res_Tk.vs.As, log2FoldChange < 0)
higher_in_Al1 <- subset(sig_res_Tk.vs.Al, log2FoldChange < 0)
higher_in_As2 <- subset(sig_res_Ac.vs.As, log2FoldChange < 0)
higher_in_Al2 <- subset(sig_res_Ac.vs.Al, log2FoldChange < 0)

# Extract gene names from each list
genes_As1 <- rownames(higher_in_As1)
genes_Al1 <- rownames(higher_in_Al1)
genes_As2 <- rownames(higher_in_As2)
genes_Al2 <- rownames(higher_in_Al2)

# Combine all gene names into one vector
Noc_all_genes <- c(genes_As1, genes_Al1, genes_As2, genes_Al2)

# Remove duplicate gene names
Noc_unique_genes <- unique(Noc_all_genes)

# Convert to a data frame for saving
Noc_unique_genes_df <- data.frame(GeneName = Noc_unique_genes)

# Save as a CSV file
write.csv(Noc_unique_genes_df, "unique_genes_combined.csv", row.names = FALSE)

# View the final unique gene names
head(Noc_unique_genes_df)

```


## Extract Gene Names and IDs
```{r}
# library(rtracklayer)
# library(dplyr)
# 
# # Load GFF3 file
# gff_file <- "Maylandia_zebra.M_zebra_UMD2a.113.gff3"
# gff_data <- import.gff3(gff_file)
# 
# # Filter for gene entries
# gene_data <- gff_data[gff_data$type == "gene", ]
# 
# # Extract Gene ID and Name
# gene_info <- data.frame(GeneID = gene_data$ID, GeneName = gene_data$Name)
# 
# # Save to CSV
# write.csv(gene_info, "M_zebra_gene_info.csv", row.names = FALSE)
# 
# # View output
# head(gene_info)

gene_info <- read.csv("M_zebra_gene_info.csv")
```

## Select Diu Genes from Normalized Counts
```{r}
# Extract normalized counts
normalized_counts <- counts(dds, normalized = TRUE)

# Ensure Noc_unique_genes is a vector of gene names or gene IDs
# If Noc_unique_genes is a vector of gene names, match by row names in normalized_counts
Diu_selected_counts <- normalized_counts[rownames(normalized_counts) %in% Diu_unique_genes, ]

# Convert the result to a data frame
Diu_selected_counts_df <- as.data.frame(Diu_selected_counts)

# Save the data frame to CSV (optional)
write.csv(Diu_selected_counts_df, "Diu_selected_normalized_counts.csv", row.names = TRUE)

# View the first few rows of the data frame
head(Diu_selected_counts_df)

```

## Calculate the Average by Clade
```{r}
# Ensure required packages are loaded
library(dplyr)
library(ggplot2)
library(tidyr)

# Transpose and calculate the mean per clade
Diu_avg_counts <- as.data.frame(t(Diu_selected_counts_df)) %>%
  mutate(clade = colData(dds)$clade) %>%
  group_by(clade) %>%
  summarise(across(everything(), mean))

# Transpose back and restore gene names
Diu_avg_counts <- as.data.frame(t(Diu_avg_counts))
colnames(Diu_avg_counts) <- Diu_avg_counts[1,]  # Set first row as column names (clades)
Diu_avg_counts <- Diu_avg_counts[-1, ]  # Remove first row
```


## Merge gene info to selected counts data
```{r}
# Convert rownames of Diu_selected_counts into a column
Diu_avg_counts$GeneID <- rownames(Diu_avg_counts)

# Merge with gene_info to get GeneName
Diu_avg_counts <- merge(Diu_avg_counts, gene_info[, c("GeneID", "GeneName")], 
                             by = "GeneID", all.x = TRUE)

# Move GeneName column to the first column for readability
Diu_avg_counts_df <- Diu_avg_counts[, c("GeneName", "GeneID", setdiff(colnames(Diu_avg_counts), c("GeneName", "GeneID")))]

# View first few rows
head(Diu_avg_counts_df)

# Save the new dataset (optional)
write.csv(Diu_avg_counts_df, "Diu_selected_counts_with_GeneName.csv", row.names = FALSE)

```


```{r}
# remove geneID
Diu_avg_counts_df <- Diu_avg_counts_df[,-2]

# Transform from wide to long format
Diu_avg_long  <- Diu_avg_counts_df %>% pivot_longer(-GeneName) %>%
set_names(c("GeneName","Species", "Gene_expression"))

Diu_avg_long$Gene_expression <- as.numeric(Diu_avg_long$Gene_expression)

# Heatmap using ggplot2
Diu_avg_long %>% 
  ggplot(aes(x = Species, y = GeneName, fill = Gene_expression)) +
  geom_tile() + 
  scale_fill_gradient(low = "#FFFFFF", high = "#f46d43", name = "Expression") +
  theme_classic() +
  theme(axis.title.x = element_markdown(),
        axis.title.y = element_markdown(),
        axis.line = element_blank(),
        axis.ticks = element_blank()) #+
  #coord_fixed(ratio = 0.2)

```


```{r}
# Adjust cell size and ensure no cutting by increasing figure size
pheatmap(Diu_avg_counts_df,
         color = heatmap_colors,            # Color scale
         cluster_rows = TRUE,                # Cluster rows to show dendrogram
         cluster_cols = TRUE,                 # Cluster columns to show dendrogram
         show_rownames = TRUE,                # Show gene names
         show_colnames = TRUE,                # Show species names
         border_color = NA,                   # Remove grid lines
         #main = "Gene Expression Heatmap",    # Title
         fontsize_row = 10,                    # Adjust row font size
         fontsize_col = 10,                    # Adjust column font size
         cellwidth = 60,                        # Increase cell width
         cellheight = 20,                       # Increase cell height
         treeheight_row = 50,                   # Height of row dendrogram
         treeheight_col = 50,                   # Height of column dendrogram
         filename = "heatmap_output.png",       # Save to a file to avoid truncation
         width = 12,                            # Adjust width to fit
         height = 10                            # Adjust height to fit
)
```


```{r}
library(ggplot2)
library(ggrepel)

# Define genes of interest
selected_genes <- c("GeneX", "GeneY", "GeneZ")  # Replace with actual gene names

# Convert results to data frame if necessary
res_Tk.vs.As_df <- as.data.frame(res_Tk.vs.As)

# Create volcano plot
ggplot(res_Tk.vs.As_df, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = ifelse(rownames(res_Tk.vs.As_df) %in% selected_genes, "highlight", "normal")), alpha = 0.5) +
  scale_color_manual(values = c("highlight" = "red", "normal" = "black")) + 
  geom_text_repel(aes(label = ifelse(rownames(res_Tk.vs.As_df) %in% selected_genes, rownames(res_Tk.vs.As_df), "")), 
                  size = 4, box.padding = 0.5, max.overlaps = 20) +
  theme_minimal() +
  labs(title = "Volcano Plot: Differential Expression", 
       x = "Log2 Fold Change", 
       y = "-Log10 Adjusted P-value") +
  theme(legend.position = "none")

```


## Comparism among nocturnal and Diurnal
```{r}
# Read raw counts data
raw_counts <- read.csv("cichlids_counts_data.csv", row.names = 1)

# Ensure your coldata is already defined as mentioned
clade <- factor(c("A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "A_labrosus", "A_labrosus", "A_labrosus", "A_labrosus", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti"))

sex <- factor(c("male", "male", "male", "male", "male", "female",
                "male", "female", "male", "female", "female", "female",
               "female", "male", "female", "male",
               "female", "female", "male", "male", "male", "female"))

coldata <- data.frame(row.names = colnames(raw_counts), clade, sex)


# Run DESeq

dds <- DESeqDataSetFromMatrix(countData = Counts, 
                              colData = coldata, 
                              design = ~clade + sex + clade:sex)

dds <- DESeq(dds)


## Diurnal vs Diurnal
# Extract results for T_kumwera vs A_calliptera
res_diurnal <- results(dds, contrast = c("clade", "T_kumwera", "A_calliptera"))


# View the results
head(res_diurnal)

## Nocturnal vs Nocturnal
# Extract results for A_labrosus vs A_stuartgranti
res_nocturnal <- results(dds, contrast = c("clade", "A_labrosus", "A_stuartgranti"))

# View the results
head(res_nocturnal)

# Filter genes with padj < 0.05 (statistically significant)
nsig_res_diurnal0.05 <- subset(res_diurnal, padj > 0.05)
nsig_res_nocturnal0.05 <- subset(res_nocturnal, padj > 0.05)

# Extract gene names from each list
genes_diurnal0.05 <- rownames(nsig_res_diurnal0.05)
genes_nocturnal0.05 <- rownames(nsig_res_nocturnal0.05)

# Combine all gene names into one vector
all_genes0.05 <- intersect(genes_diurnal0.05, genes_nocturnal0.05)

# Convert to a data frame for saving
all_0.05_genes_df <- data.frame(GeneName = all_genes0.05)


## Select Genes from Normalized Counts
# Extract normalized counts
normalized_counts <- counts(dds, normalized = TRUE)

# Ensure Noc_unique_genes is a vector of gene names or gene IDs
# If Noc_unique_genes is a vector of gene names, match by row names in normalized_counts
all_genes_counts <- normalized_counts[rownames(normalized_counts) %in% all_genes, ]

# Convert the result to a data frame
all_genes_counts_df <- as.data.frame(all_genes_counts)
```


```{r}
# Filter genes with padj < 0.05 (statistically significant)
nsig_res_diurnal0.01 <- subset(res_diurnal, padj > 0.01)
nsig_res_nocturnal0.01 <- subset(res_nocturnal, padj > 0.01)

# Extract gene names from each list
genes_diurnal0.01 <- rownames(nsig_res_diurnal0.01)
genes_nocturnal0.01 <- rownames(nsig_res_nocturnal0.01)

# Combine all gene names into one vector
all_genes0.01 <- intersect(genes_diurnal0.01, genes_nocturnal0.01)

# Convert to a data frame for saving
all_0.01_genes_df <- data.frame(GeneName = all_genes0.01)


## Select Genes from Normalized Counts
# Extract normalized counts
normalized_counts <- counts(dds, normalized = TRUE)

# Ensure Noc_unique_genes is a vector of gene names or gene IDs
# If Noc_unique_genes is a vector of gene names, match by row names in normalized_counts
all_genes_counts <- normalized_counts[rownames(normalized_counts) %in% all_genes, ]

# Convert the result to a data frame
all_genes_counts_df <- as.data.frame(all_genes_counts)
```


## Calculate the Average by Clade
```{r}
# Ensure required packages are loaded
library(dplyr)
library(ggplot2)
library(tidyr)

# Transpose and calculate the mean per clade
all_genes_counts_avg <- as.data.frame(t(all_genes_counts_df)) %>%
  mutate(clade = colData(dds)$clade) %>%
  group_by(clade) %>%
  summarise(across(everything(), mean))

# Transpose back and restore gene names
all_genes_counts_avg <- as.data.frame(t(all_genes_counts_avg))
colnames(all_genes_counts_avg) <- all_genes_counts_avg[1,]  # Set first row as column names (clades)
all_genes_counts_avg <- all_genes_counts_avg[-1, ]  # Remove first row
```


## Merge gene info to selected counts data
```{r}
# load gene_info
gene_info <- read.csv("M_zebra_gene_info.csv")

# Convert rownames of Diu_selected_counts into a column
all_genes_counts_avg$GeneID <- rownames(all_genes_counts_avg)

# Merge with gene_info to get GeneName
all_genes_counts_avg <- merge(all_genes_counts_avg, gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)

# Move GeneName column to the first column for readability
all_genes_counts_avg_df <- all_genes_counts_avg[, c("GeneName", "GeneID", setdiff(colnames(all_genes_counts_avg), c("GeneName", "GeneID")))]

# View first few rows
head(all_genes_counts_avg_df)

# Save the new dataset (optional)
write.csv(all_genes_counts_avg_df, "all_genes_counts_avg_df.csv", row.names = FALSE)

```


```{r}
# Read raw counts data
raw_counts <- read.csv("cichlids_counts_data.csv", row.names = 1)

# Ensure your coldata is already defined as mentioned
clade <- factor(c("A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "A_labrosus", "A_labrosus", "A_labrosus", "A_labrosus", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti"))

activity_pattern <- factor(c(
        "diurnal", "diurnal", "diurnal", "diurnal", "diurnal","diurnal","diurnal",          "diurnal", "diurnal", "diurnal", "diurnal", "diurnal",
        "nocturnal", "nocturnal", "nocturnal", "nocturnal", "nocturnal",                    "nocturnal", "nocturnal", "nocturnal", "nocturnal", "nocturnal"))

coldata <- data.frame(row.names = colnames(raw_counts), clade, activity_pattern)

dds <- DESeqDataSetFromMatrix(countData = raw_counts, 
                              colData = coldata, 
                              design = ~ activity_pattern)  # Compare diurnal vs nocturnal


 dds <- DESeq(dds)  
results_diurnal_vs_nocturnal <- results(dds, contrast = c("activity_pattern", "diurnal", "nocturnal"))

```

# log2FoldChange > 1 & padj < 0.05
```{r}
library(ggplot2)
library(dplyr)

# Prepare data
df <- as.data.frame(results_diurnal_vs_nocturnal)  # Convert DESeq2 results to dataframe
df$Gene <- rownames(df)  # Add gene names

# Define significance thresholds
df <- df %>%
  mutate(Significance = case_when(
    log2FoldChange > 1 & padj < 0.05 ~ "Up in Diurnal",
    log2FoldChange < -1 & padj < 0.05 ~ "Up in Nocturnal",
    TRUE ~ "Not Significant"
  ))

# Create the bi-directional volcano plot
ggplot(df, aes(x = log2FoldChange, y = -log10(padj), color = Significance)) +
  geom_point(alpha = 0.6, size = 2) +
  scale_color_manual(values = c("Up in Diurnal" = "#f46d43",  # Orange
                                "Up in Nocturnal" = "#2166ac", # Blue
                                "Not Significant" = "gray")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  labs(title = "Bi-Directional Volcano Plot: Diurnal vs Nocturnal",
       x = "Log2 Fold Change",
       y = "-Log10 Adjusted p-value",
       color = "Expression Pattern") +
  theme_minimal()

```

 
```{r}
library(ggplot2)
library(dplyr)
library(ggrepel)  # For better text labeling

# Load gene information and ensure column names match
gene_info <- read.csv("M_zebra_gene_info.csv")

# Convert DESeq2 results to a dataframe
df <- as.data.frame(results_diurnal_vs_nocturnal)  
df$GeneID <- rownames(df)  # Store gene IDs

# Merge with gene_info to get GeneName
df <- merge(df, gene_info[, c("GeneID", "GeneName")], by = "GeneID", all.x = TRUE)
# Define significance thresholds

df <- df %>%
  mutate(Significance = case_when(
    log2FoldChange > 1 & padj < 0.05 ~ "Up in Diurnal",
    log2FoldChange < -1 & padj < 0.05 ~ "Up in Nocturnal",
    TRUE ~ "Not Significant"
  ))

# Select top 20 most significant genes (lowest padj values)
top_genes <- df %>%
  filter(padj < 0.05) %>%
  arrange(padj) %>%
  head(20)  # Select top 20 based on smallest padj

# Create the bi-directional volcano plot
ggplot(df, aes(x = log2FoldChange, y = -log10(padj), color = Significance)) +
  geom_point(alpha = 0.6, size = 2) +
  scale_color_manual(values = c("Up in Diurnal" = "#f46d43",  # Orange
                                "Up in Nocturnal" = "#2166ac", # Blue
                                "Not Significant" = "gray")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
  geom_text_repel(data = top_genes, aes(label = GeneName), size = 4, max.overlaps = 20) +  # Label top 20 genes by name
  labs(title = "Bi-Directional Volcano Plot: Diurnal vs Nocturnal",
       x = "Log2 Fold Change",
       y = "-Log10 Adjusted p-value",
       color = "Expression Pattern") +
  theme_minimal()

```

```{r}
# Read raw counts data
raw_counts <- read.csv("cichlids_counts_data.csv", row.names = 1)

# Ensure your coldata is already defined as mentioned
clade <- factor(c("A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "A_calliptera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "T_kumwera", "A_labrosus", "A_labrosus", "A_labrosus", "A_labrosus", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti", "A_stuartgranti"))

activity_pattern <- factor(c(
        "diurnal", "diurnal", "diurnal", "diurnal", "diurnal","diurnal","diurnal",          "diurnal", "diurnal", "diurnal", "diurnal", "diurnal",
        "nocturnal", "nocturnal", "nocturnal", "nocturnal", "nocturnal",                    "nocturnal", "nocturnal", "nocturnal", "nocturnal", "nocturnal"))

coldata <- data.frame(row.names = colnames(raw_counts), clade, activity_pattern)

dds <- DESeqDataSetFromMatrix(countData = raw_counts, 
                              colData = coldata, 
                              design = ~ activity_pattern)  # Compare diurnal vs nocturnal


dds <- DESeq(dds)  
results_diurnal_vs_nocturnal <- results(dds, contrast = c("activity_pattern", "diurnal", "nocturnal"))

# Prepare data
df <- as.data.frame(results_diurnal_vs_nocturnal)  # Convert DESeq2 results to dataframe

df0.05 <- subset(df, padj < 0.05)
df0.01 <- subset(df, padj < 0.01)

df0.05$GeneID <- rownames(df0.05)
df0.01$GeneID <- rownames(df0.01)

write.csv(df0.05, "df0point05.csv", row.names = FALSE)
write.csv(df0.01, "df0point01.csv", row.names = FALSE)

# get gene list
gene_list <- df0.01$GeneID

```


```{r}
# Select the Ensembl database
ensembl_mart <- useMart("ensembl")

# Choose the Maylandia zebra dataset (replace with the exact dataset name from `listDatasets()`)
mzebra_mart <- useMart("ensembl", dataset = "mzebra_gene_ensembl")


# #Before using "mzebra_gene_ensembl", check if Maylandia zebra is available in Ensembl:
# ensembl_mart <- useMart("ensembl")
# datasets <- listDatasets(ensembl_mart)
# View(datasets)  # Browse available datasets

# Retrieve gene information
gene_info <- getBM(
    attributes = c("ensembl_gene_id", "external_gene_name", "description", "go_id", "name_1006"),
    mart = mzebra_mart
)

# View the first few rows
head(gene_info)

# Save to CSV file
#write.csv(gene_info, "Maylandia_zebra_gene_annotations.csv", row.names = FALSE)

# Rename columns to match AnnotationForge requirements
gene_info <- gene_info %>%
  rename(GID = ensembl_gene_id, GENENAME = external_gene_name, GO = go_id)

# Remove rows where GENENAME is empty
gene_info_clean <- gene_info %>%
  filter(GENENAME != "")

# Remove rows where GO is empty
gene_info_clean <- gene_info %>%
  filter(GO != "")

library(dplyr)

# Collapse GO terms and name_1006 by GID
gene_info_collapsed <- gene_info_clean %>%
  group_by(GID) %>%
  summarise(
    GENENAME = first(GENENAME),  # Keeping the first available GENENAME
    description = first(description),  # Keeping the first description
    GO = paste(unique(GO), collapse = ";"),  # Collapsing unique GO terms
    name_1006 = paste(unique(name_1006), collapse = ";")  # Collapsing unique names
  ) %>%
  ungroup()

# View the collapsed data
head(gene_info_collapsed)

```


```{r}
# # Ensure the directory exists
# output_dir <- "mzebra_OrgDb_v2"  # Choose a different directory
# dir.create(output_dir)  # Ensure the directory exists

output_dir <- "mzebra_OrgDb_v3"
dir.create(output_dir)

makeOrgPackage(
    gene_info = gene_info_collapsed,
    version = "1.0",
    maintainer = "Lawal Agboola <agboolalawal43@gmail.com>",
    author = "Lawal Agboola",
    outputDir = output_dir,  
    tax_id = "106582",  
    genus = "Maylandia", 
    species = "zebra",
    go_table = gene_info
) 

# Install the custom OrgDb package
install.packages("mzebra_OrgDb_v3/org.Mzebra.eg.db", repos = NULL, type = "source")

# Load the OrgDb package
library(org.Mzebra.eg.db)

keytypes(org.Mzebra.eg.db)
columns(org.Mzebra.eg.db)

db <- AnnotationDbi::dbconn(org.Mzebra.eg.db)
dbListTables(db)

```


```{r}
ego <- enrichGO(
  gene          = gene_list, 
  OrgDb         = org.Mzebra.eg.db, 
  keyType       = "GENENAME",  # Ensure your keys match your gene list
  ont           = "BP",       # Biological Process (BP), Cellular Component (CC), or Molecular Function (MF)
  pAdjustMethod = "BH",
  pvalueCutoff  = 0.05,
  qvalueCutoff  = 0.05
)

# View results
head(ego) 

# Visualize with a dot plot
dotplot(ego, showCategory = 20)

```

